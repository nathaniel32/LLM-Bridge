<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WS LLM Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']],
                packages: {'[+]': ['ams']},
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'no-mathjax',
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax loaded');
                    });
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Markdown Styles */
        .markdown-content {
            line-height: 1.7;
        }
        .markdown-content h1 { font-size: 1.875rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: 0.875rem; }
        .markdown-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.75rem; }
        .markdown-content p { margin-bottom: 1rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-content li { margin-bottom: 0.5rem; }
        .markdown-content code {
            background: #f1f5f9;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Courier New', monospace;
        }
        .markdown-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .markdown-content blockquote {
            border-left: 4px solid #cbd5e1;
            padding-left: 1rem;
            color: #64748b;
            margin-bottom: 1rem;
        }
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content th {
            background: #f8fafc;
            font-weight: 600;
        }
        
        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Slide In Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak class="h-screen flex flex-col">
        <!-- Notifications -->
        <notification-messages :messages="messages"></notification-messages>

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center gap-3">
                    <i class="fas fa-robot text-blue-600 text-xl"></i>
                    <h1 class="text-lg font-semibold text-gray-800">LLM Chat</h1>
                </div>
                <div class="flex items-center gap-3">
                    <!-- WebSocket Status -->
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium"
                         :class="{
                             'bg-green-100 text-green-700': wsConnected,
                             'bg-yellow-100 text-yellow-700': wsConnecting,
                             'bg-red-100 text-red-700': !wsConnected && !wsConnecting
                         }">
                        <span class="w-2 h-2 rounded-full"
                              :class="{
                                  'bg-green-500 animate-pulse-custom': wsConnected,
                                  'bg-yellow-500 animate-pulse-custom': wsConnecting,
                                  'bg-red-500': !wsConnected && !wsConnecting
                              }"></span>
                        <span class="hidden sm:inline">
                            {{ wsConnected ? 'Connected' : wsConnecting ? 'Connecting...' : 'Disconnected' }}
                        </span>
                    </div>
                    
                    <button 
                        @click="toggleSidebar"
                        class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        <i :class="sidebarOpen ? 'fas fa-chevron-left' : 'fas fa-bars'"></i>
                        <span class="hidden sm:inline">{{ sidebarOpen ? 'Hide' : 'Groups' }}</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside 
                v-show="sidebarOpen"
                class="w-80 bg-white border-r border-gray-200 flex flex-col transition-all duration-300"
            >
                <!-- Sidebar Header -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                            <i class="fas fa-users mr-2"></i>Groups
                        </h2>
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full font-medium">
                            {{ groupsCredential.length }}
                        </span>
                    </div>
                    <button 
                        @click="createGroup"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-sm hover:shadow-md"
                    >
                        <i class="fas fa-plus"></i>
                        <span class="font-medium">Create New Group</span>
                    </button>
                </div>
                
                <!-- Groups List -->
                <div class="flex-1 overflow-y-auto p-3">
                    <groups-list
                        v-if="groupsCredential && groupsCredential.length > 0"
                        :groups="groupsCredential"
                        :joined-group-id="joinedGroupInfo ? joinedGroupInfo.credential.id : null"
                        @join="joinGroup"
                        @delete="deleteGroup"
                    ></groups-list>
                    
                    <div v-else class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <p class="text-sm text-gray-500">No groups yet</p>
                    </div>
                </div>

                <!-- Server Stats Footer -->
                <div class="border-t border-gray-200 p-3 bg-gray-50">
                    <div class="text-xs text-gray-600 space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-user text-green-600"></i>
                                <span>Client</span>
                            </div>
                            <strong class="text-gray-900">{{ clientNum !== null ? '#' + clientNum : '-' }}</strong>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-cog text-indigo-600"></i>
                                <span>Workers</span>
                            </div>
                            <strong class="text-gray-900">{{ workerNum !== null ? workerNum : '-' }}</strong>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users text-pink-600"></i>
                                <span>Total Groups</span>
                            </div>
                            <strong class="text-gray-900">{{ groupNum !== null ? groupNum : '-' }}</strong>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-list text-orange-600"></i>
                                <span>Queue Length</span>
                            </div>
                            <strong class="text-gray-900">{{ queueLength !== null ? queueLength : '-' }}</strong>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="flex-1 flex flex-col bg-gray-50">
                <!-- Status Panel -->
                <div 
                    v-if="hasActiveConnection"
                    class="bg-white border-b border-gray-200 px-4 py-2"
                >
                    <div class="flex items-center gap-4 text-xs text-gray-600 flex-wrap">
                        <div v-if="joinedGroupInfo" class="flex items-center gap-2">
                            <i class="fas fa-id-badge text-blue-600"></i>
                            <span>Group: <strong class="text-gray-900 font-mono">{{ joinedGroupInfo.credential.id }}</strong></span>
                        </div>
                        <div v-if="joinedGroupInfo" class="flex items-center gap-2">
                            <i class="fas fa-tag text-purple-600"></i>
                            <span>Title: <strong class="text-gray-900">{{ joinedGroupInfo.credential.title }}</strong></span>
                        </div>
                        <div v-if="joinedGroupInfo && joinedGroupInfo.queue_position > 0" class="flex items-center gap-2">
                            <i class="fas fa-clock text-yellow-600"></i>
                            <span>Queue Position: <strong class="text-gray-900">{{ joinedGroupInfo.queue_position }}</strong></span>
                        </div>
                        <div v-if="joinedGroupInfo" class="flex items-center gap-2">
                            <span 
                                class="inline-block text-xs px-2.5 py-1 rounded-full font-semibold uppercase tracking-wide"
                                :class="{
                                    'bg-gray-100 text-gray-700 border border-gray-200': joinedGroupInfo.status === 'idle',
                                    'bg-yellow-100 text-yellow-700 border border-yellow-200 animate-pulse-custom': joinedGroupInfo.status === 'processing'
                                }"
                            >
                                <i :class="{
                                    'fas fa-pause-circle': joinedGroupInfo.status === 'idle',
                                    'fas fa-spinner fa-spin': joinedGroupInfo.status === 'processing'
                                }" class="mr-1"></i>
                                Group {{ joinedGroupInfo.status }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div 
                    ref="messagesContainer"
                    class="flex-1 overflow-y-auto px-4 py-6"
                    style="scroll-behavior: smooth;"
                >
                    <div class="max-w-4xl mx-auto">
                        <!-- Empty State -->
                        <div v-if="interactions.length === 0" class="text-center py-16">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                                <i class="fas fa-comments text-2xl text-blue-600"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Start a conversation</h3>
                            <p class="text-gray-600">
                                Type a message below to begin chatting
                            </p>
                        </div>

                        <!-- Messages -->
                        <interaction-messages 
                            :interactions="interactions"
                            @edit="requestEdit"
                            @delete="requestDelete"
                        ></interaction-messages>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="bg-white border-t border-gray-200 p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <textarea 
                                    v-model="messageInput"
                                    @keydown.enter.exact.prevent="sendMessage"
                                    placeholder="Type your message... (Press Enter to send)"
                                    rows="1"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all resize-none"
                                    style="max-height: 200px;"
                                ></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button 
                                    @click="sendMessage"
                                    :disabled="!messageInput.trim() || isGroupProcessing"
                                    class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all disabled:bg-gray-300 disabled:cursor-not-allowed font-medium shadow-sm hover:shadow-md"
                                >
                                    <i class="fas fa-paper-plane mr-2"></i>Send
                                </button>
                                <button 
                                    v-if="isGroupProcessing"
                                    @click="abortJob"
                                    class="px-4 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all font-medium shadow-sm"
                                    title="Abort current interaction"
                                >
                                    <i class="fas fa-stop mr-2"></i>Abort
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Configure Marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false
        });

        // ============================
        // Component: Notification Messages
        // ============================
        Vue.component('notification-messages', {
            props: ['messages'],
            template: `
                <div class="fixed top-4 right-4 z-50 space-y-2" style="width: 320px;">
                    <div 
                        v-for="m in messages" 
                        :key="m.id" 
                        class="px-4 py-3 rounded-lg shadow-lg animate-slide-in text-sm font-medium"
                        :class="{
                            'bg-blue-500 text-white': m.status === 'info',
                            'bg-green-500 text-white': m.status === 'success',
                            'bg-yellow-500 text-gray-900': m.status === 'warning',
                            'bg-red-500 text-white': m.status === 'error'
                        }"
                    >
                        <div class="flex items-center gap-2">
                            <i :class="{
                                'fas fa-info-circle': m.status === 'info',
                                'fas fa-check-circle': m.status === 'success',
                                'fas fa-exclamation-triangle': m.status === 'warning',
                                'fas fa-times-circle': m.status === 'error'
                            }"></i>
                            <span>{{ m.text }}</span>
                        </div>
                    </div>
                </div>
            `
        });

        // ============================
        // Component: Groups List
        // ============================
        Vue.component('groups-list', {
            props: ['groups', 'joinedGroupId'],
            template: `
                <div class="space-y-2">
                    <group-item
                        v-for="group in groups"
                        :key="group.id"
                        :group="group"
                        :is-joined="joinedGroupId === group.id"
                        @join="$emit('join', $event)"
                        @delete="$emit('delete', $event)"
                    ></group-item>
                </div>
            `
        });

        // ============================
        // Component: Group Item
        // ============================
        Vue.component('group-item', {
            props: ['group', 'isJoined'],
            data() {
                return {
                    showDropdown: false
                };
            },
            methods: {
                toggleDropdown(e) {
                    e.stopPropagation();
                    this.showDropdown = !this.showDropdown;
                },
                handleDelete(e) {
                    e.stopPropagation();
                    this.showDropdown = false;
                    this.$emit('delete', this.group.id);
                },
                handleJoin() {
                    if (!this.isJoined) {
                        this.$emit('join', this.group.id);
                    }
                }
            },
            template: `
                <div 
                    @click="handleJoin"
                    class="relative p-3 rounded-lg border-2 transition-all cursor-pointer"
                    :class="isJoined ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200 hover:bg-gray-100 hover:border-gray-300'"
                >
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0 pr-2">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-sm text-gray-900 truncate">{{ group.title }}</h3>
                            </div>
                            <p class="text-xs text-gray-500 font-mono truncate">{{ group.id }}</p>
                        </div>
                        
                        <!-- Dropdown Button -->
                        <div class="relative flex-shrink-0">
                            <button 
                                @click="toggleDropdown"
                                class="p-1.5 hover:bg-gray-200 rounded-md transition-colors"
                                :class="isJoined ? 'hover:bg-blue-100' : ''"
                            >
                                <i class="fas fa-ellipsis-v text-gray-600"></i>
                            </button>

                            <div 
                                v-show="showDropdown"
                                @click.stop
                                class="absolute right-0 top-1/2 translate-y-[6px] w-40 bg-white rounded-lg shadow-lg border border-gray-200 z-20 overflow-hidden"
                            >
                                <button
                                    @click="handleDelete"
                                    class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                >
                                    <i class="fas fa-trash"></i>
                                    <span>Delete Group</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Joined Indicator -->
                    <div v-if="isJoined" class="mt-2 flex items-center gap-2 text-xs text-blue-600">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-medium">Currently Joined</span>
                    </div>
                </div>
            `
        });

        // ============================
        // Component: Interaction Messages
        // ============================
        Vue.component('interaction-messages', {
            props: ['interactions'],
            methods: {
                renderMarkdown(text) {
                    if (!text) return '';
                    return marked.parse(text);
                },
                updateMathJax() {
                    this.$nextTick(() => {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
                        }
                    });
                }
            },
            watch: {
                interactions: {
                    handler() {
                        this.updateMathJax();
                    },
                    deep: true
                }
            },
            mounted() {
                this.updateMathJax();
            },
            template: `
                <div class="space-y-6">
                    <div v-for="item in interactions" :key="item.id" class="animate-fade-in">
                        <!-- User Message -->
                        <div class="flex justify-end mb-4">
                            <div class="max-w-[70%] bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-sm shadow-sm">
                                <p class="text-sm leading-relaxed whitespace-pre-wrap">{{ item.prompt }}</p>
                            </div>
                        </div>
                        
                        <!-- Assistant Message -->
                        <div class="flex gap-3 mb-4">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-semibold text-sm shadow-md">
                                    AI
                                </div>
                            </div>
                            <div class="flex-1 max-w-[85%] group">
                                <div class="bg-white px-4 py-3 rounded-2xl rounded-tl-sm shadow-sm border border-gray-200">
                                    <!-- Response Content -->
                                    <div v-if="item.response" class="markdown-content text-sm text-gray-800 mb-3" v-html="renderMarkdown(item.response)"></div>
                                    <div v-else-if="item.status === 'queued'" class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                                        <i class="fas fa-hourglass-half"></i>
                                        <span>Queued...</span>
                                    </div>
                                    <div v-else-if="item.status === 'processing'" class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Thinking...</span>
                                    </div>
                                    <div v-else-if="item.status === 'failed'" class="flex items-center gap-2 text-sm text-red-600 mb-3">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span>Failed to generate response</span>
                                    </div>
                                    <div v-else-if="item.status === 'aborted'" class="flex items-center gap-2 text-sm text-orange-600 mb-3">
                                        <i class="fas fa-ban"></i>
                                        <span>Response was aborted</span>
                                    </div>
                                    
                                    <!-- Status Badge -->
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">Status:</span>
                                        <span 
                                            class="inline-block text-xs px-2.5 py-1 rounded-full font-semibold uppercase tracking-wide"
                                            :class="{
                                                'bg-blue-100 text-blue-700 border border-blue-200': item.status === 'created',
                                                'bg-purple-100 text-purple-700 border border-purple-200 animate-pulse-custom': item.status === 'queued',
                                                'bg-yellow-100 text-yellow-700 border border-yellow-200 animate-pulse-custom': item.status === 'in_progress',
                                                'bg-green-100 text-green-700 border border-green-200': item.status === 'completed',
                                                'bg-red-100 text-red-700 border border-red-200': item.status === 'failed',
                                                'bg-orange-100 text-orange-700 border border-orange-200': item.status === 'aborted',
                                                'bg-gray-100 text-gray-700 border border-gray-200': item.status === 'deleted'
                                            }"
                                        >
                                            <i :class="{
                                                'fas fa-clock': item.status === 'created',
                                                'fas fa-hourglass-half': item.status === 'queued',
                                                'fas fa-spinner fa-spin': item.status === 'processing',
                                                'fas fa-check-circle': item.status === 'completed',
                                                'fas fa-times-circle': item.status === 'failed',
                                                'fas fa-ban': item.status === 'aborted',
                                                'fas fa-trash': item.status === 'deleted'
                                            }" class="mr-1"></i>
                                            {{ item.status }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button 
                                        @click="$emit('edit', item)"
                                        :disabled="item.status === 'processing' || item.status === 'queued'"
                                        class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </button>
                                    <button 
                                        @click="$emit('delete', item)"
                                        class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
                                    >
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        });

        // ============================
        // Main Vue Instance
        // ============================
        new Vue({
            el: "#app",
            data: {
                ws: null,
                messageInput: "",
                interactions: [],
                messages: [],
                clientNum: null,
                queuePosition: null,
                queueLength: null,
                workerNum: null,
                groupNum: null,
                groupsCredential: [],
                joinedGroupInfo: null,
                heartbeatTimeout: null,
                sidebarOpen: true,
                wsConnected: false,
                wsConnecting: false,
                autoJoinGroupId: null
            },
            computed: {
                hasActiveConnection() {
                    return this.joinedGroupInfo !== null;
                },
                hasActiveInteraction() {
                    return this.interactions.some(i => i.status === 'processing' || i.status === 'queued');
                },
                isGroupProcessing() {
                    return this.joinedGroupInfo && this.joinedGroupInfo.status === 'processing';
                }
            },
            watch: {
                interactions: {
                    handler() {
                        this.$nextTick(() => {
                            this.scrollToBottom();
                        });
                    },
                    deep: true
                }
            },
            created() {
                this.autoJoinGroupFromURL();
                this.initWebSocket();
            },
            methods: {
                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                },

                scrollToBottom() {
                    const container = this.$refs.messagesContainer;
                    if (container) {
                        setTimeout(() => {
                            container.scrollTop = container.scrollHeight;
                        }, 100);
                    }
                },

                // ============================
                // WebSocket Initialization
                // ============================
                initWebSocket() {
                    this.wsConnecting = true;
                    this.wsConnected = false;

                    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                    const wsHost = window.location.host;
                    this.ws = new WebSocket(`${wsProtocol}://${wsHost}/connection/client`);
                                        
                    this.ws.addEventListener("open", () => {
                        this.wsConnected = true;
                        this.wsConnecting = false;
                        console.log('WebSocket connected');
                        this.handleAutoJoin();
                    });

                    this.ws.onclose = () => this.handleConnectionIssue('Closed');
                    this.ws.onerror = () => this.handleConnectionIssue('Error occurred');
                    this.ws.onmessage = (event) => this.handleMessage(event);
                },

                autoJoinGroupFromURL() {
                    const params = new URLSearchParams(window.location.search);
                    this.autoJoinGroupId = params.get("id");
                },

                handleAutoJoin() {
                    if (this.autoJoinGroupId) {
                        this.joinGroup(this.autoJoinGroupId);
                    }
                },

                // ============================
                // WebSocket Message Handling
                // ============================
                handleMessage(event) {
                    const data = JSON.parse(event.data);
                    console.log('Received:', data);

                    if (data.message) {
                        this.showNotification(data.message);
                    }

                    if (data.content) {
                        this.updateContent(data.content);
                    }
                },

                showNotification(message) {
                    const id = Date.now() + Math.random();
                    this.messages.push({
                        id,
                        text: message.text,
                        status: message.status
                    });

                    setTimeout(() => {
                        this.messages = this.messages.filter(m => m.id !== id);
                    }, 5000);
                },

                updateContent(content) {
                    // Update simple properties
                    if (content.client_num !== undefined && content.client_num !== null) {
                        this.clientNum = content.client_num;
                    }
                    if (content.worker_num !== undefined && content.worker_num !== null) {
                        this.workerNum = content.worker_num;
                    }
                    if (content.group_num !== undefined && content.group_num !== null) {
                        this.groupNum = content.group_num;
                    }
                    if (content.queue_length !== undefined && content.queue_length !== null) {
                        this.queueLength = content.queue_length;
                    }

                    // Update groups credentials list
                    if (content.groups_credential !== undefined && content.groups_credential !== null) {
                        this.groupsCredential = content.groups_credential;
                    }

                    // Update joined group information
                    if (content.joined_group_infos !== undefined && content.joined_group_infos !== null) {
                        const groupInfo = content.joined_group_infos;
                        
                        // If group info has credential with id, we're joined to a group
                        if (groupInfo.credential && groupInfo.credential.id) {
                            this.joinedGroupInfo = groupInfo;
                            this.updateURLWithGroupId(groupInfo.credential.id);
                        } else {
                            // Empty group info means we left the group
                            this.joinedGroupInfo = null;
                            this.interactions = [];
                            this.updateURLWithGroupId(null);
                        }
                    }

                    // Handle interaction updates
                    if (content.interaction !== undefined && content.interaction !== null) {
                        this.updateInteraction(content.interaction);
                    }
                },

                updateURLWithGroupId(groupId) {
                    const url = new URL(window.location);
                    if (groupId) {
                        url.searchParams.set("id", groupId);
                    } else {
                        url.searchParams.delete("id");
                    }
                    window.history.replaceState({}, "", url);
                },

                updateInteraction(interaction) {
                    if (interaction.status === "deleted") {
                        this.removeInteraction(interaction.id);
                    } else {
                        this.addOrUpdateInteraction(interaction);
                    }
                },

                removeInteraction(id) {
                    const index = this.interactions.findIndex(i => i.id === id);
                    if (index !== -1) {
                        this.interactions.splice(index, 1);
                    }
                },

                addOrUpdateInteraction(interaction) {
                    const index = this.interactions.findIndex(i => i.id === interaction.id);
                    if (index !== -1) {
                        this.$set(this.interactions, index, interaction);
                    } else {
                        this.interactions.push(interaction);
                    }
                },

                // ============================
                // Connection Management
                // ============================
                handleConnectionIssue(eventType) {
                    console.error(`WebSocket connection: ${eventType}`);
                    
                    this.wsConnected = false;
                    this.wsConnecting = false;

                    if (this.heartbeatTimeout) {
                        clearTimeout(this.heartbeatTimeout);
                    }

                    if (this.ws) {
                        this.ws.onclose = null;
                        this.ws.onerror = null;
                        this.ws.close();
                        this.ws = null;
                    }

                    // Auto reconnect after 5 seconds
                    setTimeout(() => {
                        if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {
                            console.log('Attempting to reconnect WebSocket...');
                            this.initWebSocket();
                        }
                    }, 5000);
                },

                // ============================
                // User Actions
                // ============================
                sendMessage() {
                    if (!this.messageInput.trim()) return;

                    this.sendAction("create_interaction", {
                        input_text: this.messageInput
                    });

                    this.messageInput = "";
                },

                abortJob() {
                    this.sendAction("abort_interaction");
                },

                requestEdit(item) {
                    const newPrompt = prompt("Edit prompt:", item.prompt);
                    if (newPrompt === null) return;

                    this.sendAction("edit_interaction", {
                        input_id: item.id,
                        input_text: newPrompt
                    });
                },

                requestDelete(item) {
                    if (confirm(`Delete interaction "${item.prompt.substring(0, 50)}..."?`)) {
                        this.sendAction("delete_interaction", {
                            input_id: item.id
                        });
                    }
                },

                createGroup() {
                    this.sendAction("create_group");
                },

                joinGroup(groupId) {
                    this.sendAction("join_group", {
                        input_id: groupId
                    });
                },

                deleteGroup(groupId) {
                    if (confirm(`Delete group: ${groupId}?`)) {
                        this.sendAction("delete_group", {
                            input_id: groupId
                        });
                    }
                },

                leaveGroup() {
                    this.sendAction("leave_group");
                },

                // ============================
                // WebSocket Communication
                // ============================
                sendAction(action, content = null) {
                    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                        console.error('WebSocket is not connected');
                        return;
                    }
                    
                    const payload = { action };
                    if (content) {
                        payload.content = content;
                    }
                    console.log('Sending:', payload);
                    this.ws.send(JSON.stringify(payload));
                }
            }
        });
    </script>
</body>
</html>