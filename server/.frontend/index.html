<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WS LLM Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f8f9fa }
        .chat { max-width: 920px; margin: auto; padding: 20px }
        
        /* Status Badge Styles for Interaction */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }
        .badge-created { background: #e3f2fd; color: #1976d2 }
        .badge-in_progress { background: #fff3e0; color: #f57c00 }
        .badge-failed { background: #ffebee; color: #c62828 }
        .badge-aborted { background: #fce4ec; color: #c2185b }
        .badge-deleted { background: #f5f5f5; color: #757575 }
        
        /* Status Badge Styles for Group */
        .badge-active { background: #e8f5e9; color: #2e7d32 }
        
        /* Interaction Styles */
        .item {
            background: #fff;
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .prompt {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .prompt-text { flex: 1 }
        .actions {
            display: flex;
            gap: 8px;
        }
        .edit {
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-weight: normal;
        }
        .edit:hover { background: #e0e0e0 }
        .response {
            white-space: pre-wrap;
            margin-top: 8px;
            color: #333;
            line-height: 1.6;
            padding-left: 12px;
            border-left: 3px solid #e0e0e0;
        }
        
        /* Messages (notifications) */
        .messages {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 320px;
            z-index: 1000;
        }
        .msg {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .info { background: #2196f3 }
        .success { background: #4caf50 }
        .warning { background: #ff9800; color: #000 }
        .error { background: #f44336 }
        
        /* Status Bar */
        .status-bar {
            background: #fff;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .status-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }
        .status-item strong {
            display: block;
            color: #666;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .status-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        /* Groups Section */
        .groups-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        .groups-header {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
        }
        .group-item {
            background: #f8f9fa;
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .group-info { flex: 1 }
        .group-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .group-id {
            font-family: monospace;
            color: #666;
            font-size: 11px;
        }
        
        /* Button Group for Groups */
        .group-button-group {
            display: flex;
            gap: 4px;
        }
        .group-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .group-btn:hover { opacity: 0.8; transform: scale(1.05) }
        .btn-join { background: #2196f3; color: #fff }
        .btn-delete-group { background: #f44336; color: #fff }
        
        /* Input Section */
        .input-section {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #2196f3;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px) }
        .btn-send { background: #2196f3; color: #fff }
        .btn-abort { background: #f44336; color: #fff }
        .btn-leave { background: #ff9800; color: #fff }
        .btn-create-group { background: #4caf50; color: #fff; width: 100%; margin-top: 12px }
        
        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="messages">
            <div v-for="m in messages" :key="m.id" class="msg" :class="m.status">
                {{ m.text }}
            </div>
        </div>

        <div class="chat">
            <h2>ü§ñ LLM Chat</h2>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-grid">
                    <div class="status-item" v-if="clientNum !== null">
                        <strong>Client #</strong>
                        <div class="status-value">{{ clientNum }}</div>
                    </div>
                    <div class="status-item" v-if="queuePosition !== null">
                        <strong>Queue Position</strong>
                        <div class="status-value">{{ queuePosition }}</div>
                    </div>
                    <div class="status-item" v-if="queueLength !== null">
                        <strong>Queue Length</strong>
                        <div class="status-value">{{ queueLength }}</div>
                    </div>
                    <div class="status-item" v-if="workerNum !== null">
                        <strong>Worker #</strong>
                        <div class="status-value">{{ workerNum }}</div>
                    </div>
                    <div class="status-item" v-if="groupNum !== null">
                        <strong>Group #</strong>
                        <div class="status-value">{{ groupNum }}</div>
                    </div>
                </div>

                <!-- Groups Info Section -->
                <div v-if="groupsInfos && groupsInfos.length > 0" class="groups-section">
                    <div class="groups-header">üìÅ Groups</div>
                    <div v-for="group in groupsInfos" :key="group.id" class="group-item">
                        <div class="group-info">
                            <div class="group-name">{{ group.name }}</div>
                            <div class="group-id">ID: {{ group.id }}</div>
                        </div>
                        <span class="badge" :class="'badge-' + group.status">
                            {{ group.status }}
                        </span>
                        <div class="group-button-group">
                            <button class="group-btn btn-join" @click="joinGroup(group.id)">
                                Join
                            </button>
                            <button class="group-btn btn-delete-group" @click="deleteGroup(group.id)">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <button class="btn-create-group" @click="createGroup">
                    ‚ûï Create New Group
                </button>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <input 
                    type="text" 
                    v-model="messageInput" 
                    @keyup.enter="sendMessage"
                    placeholder="Type your message here..."
                >
                <button class="btn-send" @click="sendMessage">Send</button>
                <button class="btn-abort" @click="abortJob">Abort</button>
                <button class="btn-leave" @click="leaveGroup">Leave Group</button>
            </div>

            <!-- Interactions -->
            <div v-for="item in interactions" :key="item.id" class="item">
                <div class="prompt">
                    <span class="prompt-text">
                        {{ item.prompt }}
                        <span class="badge" :class="'badge-' + item.status">
                            {{ item.status }}
                        </span>
                    </span>
                    <div class="actions">
                        <span class="edit" @click="requestEdit(item)">‚úèÔ∏è Edit</span>
                        <span class="edit" @click="requestDelete(item)">üóëÔ∏è Delete</span>
                    </div>
                </div>
                <div class="response" v-if="item.response">
                    {{ item.response }}
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: "#app",
            data: {
                ws: null,
                messageInput: "",
                interactions: [],
                messages: [],
                clientNum: null,
                queuePosition: null,
                queueLength: null,
                workerNum: null,
                groupNum: null,
                groupsInfos: []
            },
            created() {
                this.ws = new WebSocket("ws://localhost:9050/connection/client");

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log(data);

                    // Handle message notifications
                    if (data.message) {
                        const id = Date.now() + Math.random();
                        this.messages.push({
                            id,
                            text: data.message.text,
                            status: data.message.status
                        });

                        setTimeout(() => {
                            this.messages = this.messages.filter(m => m.id !== id);
                        }, 5000);
                    }

                    // Handle content updates
                    const content = data?.content;
                    if (!content) return;

                    // Update status properties
                    if (content.client_num !== undefined && content.client_num !== null) {
                        this.clientNum = content.client_num;
                    }
                    if (content.queue_position !== undefined && content.queue_position !== null) {
                        this.queuePosition = content.queue_position;
                    }
                    if (content.queue_length !== undefined && content.queue_length !== null) {
                        this.queueLength = content.queue_length;
                    }
                    if (content.worker_num !== undefined && content.worker_num !== null) {
                        this.workerNum = content.worker_num;
                    }
                    if (content.group_num !== undefined && content.group_num !== null) {
                        this.groupNum = content.group_num;
                    }
                    if (content.groups_infos !== undefined && content.groups_infos !== null) {
                        this.groupsInfos = content.groups_infos;
                    }

                    // Handle interaction updates
                    const interaction = content.interaction;
                    if (interaction) {
                        // Cek jika status adalah DELETED, maka hapus dari list
                        if (interaction.status === "deleted") {
                            const index = this.interactions.findIndex(
                                i => i.id === interaction.id
                            );
                            if (index !== -1) {
                                this.interactions.splice(index, 1);
                            }
                        } else {
                            // Update atau tambah interaction
                            const index = this.interactions.findIndex(
                                i => i.id === interaction.id
                            );

                            if (index !== -1) {
                                this.$set(this.interactions, index, interaction);
                            } else {
                                this.interactions.push(interaction);
                            }
                        }
                    }
                };
            },
            methods: {
                sendMessage() {
                    if (!this.messageInput.trim()) return;

                    this.ws.send(JSON.stringify({
                        action: "create_interaction",
                        content: {
                            input_text: this.messageInput
                        }
                    }));

                    this.messageInput = "";
                },
                abortJob() {
                    this.ws.send(JSON.stringify({
                        action: "abort_interaction"
                    }));
                },
                requestEdit(item) {
                    const newPrompt = prompt("Edit prompt:", item.prompt);
                    if (newPrompt === null) return;

                    this.ws.send(JSON.stringify({
                        action: "edit_interaction",
                        content: {
                            input_id: item.id,
                            input_text: newPrompt
                        }
                    }));
                },
                requestDelete(item) {
                    if (confirm(`Delete Interaction: ${item.id}`)) {
                        this.ws.send(JSON.stringify({
                            action: "delete_interaction",
                            content: {
                                input_id: item.id
                            }
                        }));
                    }
                },
                createGroup() {
                    this.ws.send(JSON.stringify({
                        action: "create_group"
                    }));
                },
                joinGroup(groupId) {
                    this.ws.send(JSON.stringify({
                        action: "join_group",
                        content: {
                            input_id: groupId
                        }
                    }));
                },
                deleteGroup(groupId) {
                    if (confirm(`Delete Group: ${groupId}?`)) {
                        this.ws.send(JSON.stringify({
                            action: "delete_group",
                            content: {
                                input_id: groupId
                            }
                        }));
                    }
                },
                leaveGroup() {
                    this.ws.send(JSON.stringify({
                        action: "leave_group"
                    }));
                }
            }
        });
    </script>
</body>
</html>